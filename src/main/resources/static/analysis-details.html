<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Détaillée - Foot Analyst V16</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <link href="/css/style.css" rel="stylesheet">
</head>
<body>

<div class="header-gradient mb-4">
    <div class="container">
        <a href="/" class="btn btn-outline-light btn-sm mb-3 rounded-pill px-3"><i class="bi bi-arrow-left me-2"></i>Retour Dashboard</a>

        <button id="btnRecalculate" class="btn btn-outline-primary btn-sm rounded-pill px-3">
            <i class="bi bi-arrow-clockwise me-2"></i>Recalculer l'IA
        </button>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start">
            <div class="mb-3 mb-md-0">
                <span class="badge bg-white text-dark text-uppercase fw-bold mb-2 px-3 py-2" id="leagueName">Championnat</span>
                <h1 class="display-5 fw-bold mb-0">
                    <span class="text-info" id="homeName">Domicile</span>
                    <span class="text-secondary mx-2 fs-4">vs</span>
                    <span class="text-danger" id="awayName">Extérieur</span>
                </h1>
                <small class="text-white-50"><i class="bi bi-calendar-event me-2"></i><span id="matchDate">--/--/----</span></small>
            </div>

            <div class="card weather-widget border-0" style="min-width: 250px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fs-6 opacity-75 text-uppercase fw-bold mb-1"><i class="bi bi-geo-alt-fill"></i> Météo Stade</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cloud-sun-fill fs-2 me-3"></i>
                            <div>
                                <h4 class="mb-0 fw-bold">14°C</h4>
                                <small class="opacity-75">Vent: 25 km/h</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5" id="mainContent" style="display:none;">

    <div id="valueBetAlert" class="alert value-bet shadow-sm d-flex align-items-center mb-4" style="display:none;">
        <i class="bi bi-stars fs-3 me-3"></i>
        <div>
            <h5 class="alert-heading fw-bold mb-0">Opportunité Value Bet Détectée !</h5>
            <span id="valueBetDesc">Misez sur ...</span>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-7">

            <div class="card mb-4">
                <div class="card-body p-4">
                    <h6 class="market-group-title"><i class="bi bi-trophy-fill me-2"></i>Résultat du Match (1N2)</h6>

                    <div class="prob-bar-container mb-2">
                        <div id="pb1" class="prob-segment bg-primary text-white" style="width: 33%">1</div>
                        <div id="pbN" class="prob-segment bg-secondary text-white-50" style="width: 34%">N</div>
                        <div id="pb2" class="prob-segment bg-danger text-white" style="width: 33%">2</div>
                    </div>

                    <div class="row text-center mt-3">
                        <div class="col-4 border-end">
                            <div class="text-primary fw-bold display-6" id="prob1">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Victoire Dom.</small>
                            <div id="kel1" class="mt-1"></div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="text-secondary fw-bold display-6" id="probN">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Match Nul</small>
                            <div id="kelN" class="mt-1"></div>
                        </div>
                        <div class="col-4">
                            <div class="text-danger fw-bold display-6" id="prob2">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Victoire Ext.</small>
                            <div id="kel2" class="mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <h6 class="market-group-title"><i class="bi bi-bullseye me-2"></i>Score le plus probable</h6>
                            <div class="score-badge text-dark bg-light d-inline-block mb-2 mt-2" id="exactScore">0-0</div>
                            <div class="text-muted fw-bold">Probabilité: <span id="exactScoreProb" class="text-dark">0%</span></div>
                            <hr class="my-3">
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Espérance Buts Dom: <strong class="text-dark" id="expHome">0.0</strong></span>
                                <span>Espérance Buts Ext: <strong class="text-dark" id="expAway">0.0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <h6 class="market-group-title"><i class="bi bi-shield-shaded me-2"></i>Double Chance</h6>
                            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
                                <span class="fw-bold text-muted">1N (Dom ou Nul)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dc1N">--%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
                                <span class="fw-bold text-muted">12 (Pas de nul)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dc12">--%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center stat-row">
                                <span class="fw-bold text-muted">N2 (Nul ou Ext)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dcN2">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-5">

            <div class="card mb-4">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="market-group-title mb-0"><i class="bi bi-hash me-2"></i>Total Buts (Under / Over)</h6>
                </div>
                <div class="card-body pt-2">

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 1.5</div>
                            <div class="stat-val text-success" id="u15">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU15" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO15" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 1.5</div>
                            <div class="stat-val text-primary" id="o15">--%</div>
                            <small id="valO15"></small>
                        </div>
                    </div>

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 2.5</div>
                            <div class="stat-val text-success" id="u25">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU25" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO25" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 2.5</div>
                            <div class="stat-val text-primary" id="o25">--%</div>
                            <small id="valO25"></small>
                        </div>
                    </div>

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 3.5</div>
                            <div class="stat-val text-success" id="u35">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU35" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO35" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 3.5</div>
                            <div class="stat-val text-primary" id="o35">--%</div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="market-group-title"><i class="bi bi-arrow-left-right me-2"></i>Les deux équipes marquent (BTTS)</h6>
                    <div class="d-flex justify-content-around align-items-center py-2">
                        <div class="text-center">
                            <h3 class="text-success mb-0 fw-bold" id="bttsYes">--%</h3>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-3">OUI</span>
                            <div id="valBTTS" class="mt-1"></div>
                        </div>
                        <div class="vr" style="height: 50px;"></div>
                        <div class="text-center">
                            <h3 class="text-danger mb-0 fw-bold" id="bttsNo">--%</h3>
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3">NON</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="market-group-title">Power Score (Forces en présence)</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span class="text-primary" id="homePowerName">DOM</span>
                            <span id="homePowerVal">0</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" id="barPowerHome" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span class="text-danger" id="awayPowerName">EXT</span>
                            <span id="awayPowerVal">0</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" id="barPowerAway" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-white"><i class="bi bi-clock-history me-2"></i>Confrontations (H2H)</h5>

        <ul class="nav nav-pills card-header-pills" id="h2hFilters">
            <li class="nav-item">
                <button class="nav-link active btn-sm" onclick="loadH2H('ALL', this)">Tous</button>
            </li>
            <li class="nav-item">
                <button class="nav-link btn-sm" onclick="loadH2H('HOME', this)">Domicile</button>
            </li>
        </ul>
    </div>

    <div class="card-body bg-dark">
        <div id="h2hContainer" class="d-flex flex-column gap-3">
            <div class="text-center text-muted">Chargement...</div>
        </div>
    </div>
</div>

<div id="loader" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted">Chargement de l'analyse et des données météo...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- UTILS ---
    const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
    const setWidth = (id, val) => { const el = document.getElementById(id); if(el) el.style.width = val + '%'; };

    async function loadAnalysis() {
        // Récup ID depuis l'URL (ex: analysis-details.html?id=12)
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if(!id) {
            alert("Aucun ID d'analyse spécifié.");
            return;
        }

        try {
            // NOTE: Assurez-vous d'ajouter une méthode GET /api/v1/analyses/{id} dans votre Controller Java !
            // Pour l'instant, on suppose que cela fonctionne ou on adapte le controller.
            const res = await fetch(`/api/v1/analyses/${id}`); // A AJOUTER DANS LE BACKEND SI MANQUANT
            if(!res.ok) throw new Error("Analyse introuvable");

            const match = await res.json(); // Objet MatchAnalysis complet
            const p = match.prediction;

            // 1. HEADER
            setText('leagueName', match.homeTeam.league ? match.homeTeam.league.name : 'Championnat');
            setText('homeName', match.homeTeam.name);
            setText('awayName', match.awayTeam.name);
            setText('matchDate', new Date(match.matchDate).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' }));

            // Power Names
            setText('homePowerName', match.homeTeam.name);
            setText('awayPowerName', match.awayTeam.name);

            // 2. 1N2
            setText('prob1', Math.round(p.homeWinProbability) + '%');
            setText('probN', Math.round(p.drawProbability) + '%');
            setText('prob2', Math.round(p.awayWinProbability) + '%');

            setWidth('pb1', p.homeWinProbability); setText('pb1', Math.round(p.homeWinProbability)+'%');
            setWidth('pbN', p.drawProbability); setText('pbN', Math.round(p.drawProbability)+'%');
            setWidth('pb2', p.awayWinProbability); setText('pb2', Math.round(p.awayWinProbability)+'%');

            // 3. SCORES
            setText('exactScore', p.exactScore || 'N/A');
            setText('exactScoreProb', p.exactScoreProb ? Math.round(p.exactScoreProb) + '%' : '-');
            setText('expHome', p.predictedHomeGoals);
            setText('expAway', p.predictedAwayGoals);

            // 4. DOUBLE CHANCE
            setText('dc1N', p.doubleChance1N + '%');
            setText('dc12', p.doubleChance12 + '%');
            setText('dcN2', p.doubleChanceN2 + '%');

            // 5. GOALS MARKETS (Si backend mis à jour avec les nouveaux champs, sinon calcul frontend approx)

            // Over/Under 1.5 (Si pas dans JSON, on approxime depuis Over2.5 pour l'affichage demo)
            // L'idéal est que le backend renvoie p.over1_5_Prob, p.under1_5_Prob
            const o15 = p.probOver1_5 !== undefined ? p.probOver1_5 : Math.min(99, p.over2_5_Prob + 25);
            const u15 = 100 - o15;
            setText('o15', Math.round(o15) + '%'); setWidth('barO15', o15);
            setText('u15', Math.round(u15) + '%'); setWidth('barU15', u15);

            // Over/Under 2.5
            setText('o25', Math.round(p.over2_5_Prob) + '%'); setWidth('barO25', p.over2_5_Prob);
            setText('u25', Math.round(p.under2_5_Prob) + '%'); setWidth('barU25', p.under2_5_Prob);

            // Over/Under 3.5 (Simulé si absent)
            const o35 = p.probOver3_5 !== undefined ? p.probOver3_5 : Math.max(0, p.over2_5_Prob - 20);
            const u35 = 100 - o35;
            setText('o35', Math.round(o35) + '%'); setWidth('barO35', o35);
            setText('u35', Math.round(u35) + '%'); setWidth('barU35', u35);

            // BTTS
            const bttsY = p.bttsProb;
            const bttsN = p.bttsNoProb !== undefined ? p.bttsNoProb : (100 - bttsY); // Fallback
            setText('bttsYes', Math.round(bttsY) + '%');
            setText('bttsNo', Math.round(bttsN) + '%');

            // 6. POWER SCORE
            setText('homePowerVal', Math.round(p.homePowerScore));
            setWidth('barPowerHome', p.homePowerScore);
            setText('awayPowerVal', Math.round(p.awayPowerScore));
            setWidth('barPowerAway', p.awayPowerScore);

            // 7. VALUE BET DETECTION & BADGES
            const addValueBadge = (elId, kelly) => {
                const el = document.getElementById(elId);
                if(kelly > 0 && el) el.innerHTML = `<span class="badge bg-warning text-dark border border-warning mt-1"><i class="bi bi-star-fill me-1"></i>Value!</span>`;
            };

            // 1N2 Value
            if(p.valueBetDetected) {
                const alertBox = document.getElementById('valueBetAlert');
                alertBox.style.display = 'flex';
                let txt = "";
                if(p.kellyStakeHome > 0) { txt = `Victoire ${match.homeTeam.name} (@${match.odds1})`; addValueBadge('kel1', 1); }
                else if(p.kellyStakeAway > 0) { txt = `Victoire ${match.awayTeam.name} (@${match.odds2})`; addValueBadge('kel2', 1); }
                else if(p.kellyStakeDraw > 0) { txt = `Match Nul (@${match.oddsN})`; addValueBadge('kelN', 1); }
                setText('valueBetDesc', txt);
            }

            // Goals Value
            addValueBadge('valO15', p.kellyOver1_5);
            addValueBadge('valO25', p.kellyOver2_5);
            addValueBadge('valBTTS', p.kellyBTTS);

            // FIN CHARGEMENT
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

        } catch(e) {
            console.error(e);
            document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erreur de chargement: ${e.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', loadAnalysis);
</script>

<script>
    // Récupérer l'ID du match depuis l'URL (ex: ?id=123)
    const urlParams = new URLSearchParams(window.location.search);
    const currentMatchId = urlParams.get('id');
    // On stocke l'ID de l'équipe domicile actuelle pour savoir si c'est une victoire ou défaite pour elle
    let currentHomeTeamId = null;

    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. On récupère d'abord les infos du match actuel pour avoir l'ID de l'équipe Home
        // (Tu as probablement déjà un fetch pour le match principal, récupère l'ID là-bas)
        const res = await fetch(`/api/v1/analyses/${currentMatchId}`); // Supposons que cet endpoint existe
        const match = await res.json();
        currentHomeTeamId = match.homeTeam.id;

        // 2. Charger l'historique par défaut
        await loadH2H('ALL');
    });

    async function loadH2H(filter, btnElement) {
        // Gestion UI des boutons (Active state)
        if(btnElement) {
            document.querySelectorAll('#h2hFilters .nav-link').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        const container = document.getElementById('h2hContainer');
        container.innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Chargement...</div>';

        try {
            const response = await fetch(`/api/v1/analyses/${currentMatchId}/h2h?filter=${filter}`);
            const matches = await response.json();

            if (matches.length === 0) {
                container.innerHTML = '<div class="text-center text-muted small">Aucune confrontation trouvée.</div>';
                return;
            }

            let html = '';
            matches.forEach(m => {
                if(m.homeScore === null) return; // Ignorer matchs non joués

                // --- LOGIQUE COULEUR (V/N/D) ---
                // On analyse le résultat du point de vue de currentHomeTeamId
                let resultClass = 'res-draw';
                let resultLabel = 'N';

                // Qui a gagné ce match historique ?
                let winnerId = null;
                if (m.homeScore > m.awayScore) winnerId = m.homeTeam.id;
                else if (m.awayScore > m.homeScore) winnerId = m.awayTeam.id;

                if (winnerId === currentHomeTeamId) {
                    resultClass = 'res-win'; // Vert
                    resultLabel = 'V';
                } else if (winnerId !== null) { // Quelqu'un a gagné, mais pas nous
                    resultClass = 'res-loss'; // Rouge
                    resultLabel = 'D';
                }

                // Formatage Date
                const date = new Date(m.matchDate).toLocaleDateString('fr-FR', {year: '2-digit', month:'2-digit', day:'2-digit'});

                html += `
                <div class="match-row ${resultClass} d-flex justify-content-between align-items-center">
                    <div class="d-flex flex-column" style="width: 80px;">
                        <span class="text-muted small" style="font-size:0.75rem">${date}</span>
                        <span class="badge bg-secondary text-dark bg-opacity-25 border border-secondary border-opacity-25" style="width:fit-content">${m.season || 'Ligue'}</span>
                    </div>

                    <div class="flex-grow-1 text-center px-3">
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <span class="${m.homeTeam.id === currentHomeTeamId ? 'fw-bold text-white' : 'text-muted'}">${m.homeTeam.name}</span>
                            <span class="score-badge text-white">${m.homeScore} - ${m.awayScore}</span>
                            <span class="${m.awayTeam.id === currentHomeTeamId ? 'fw-bold text-white' : 'text-muted'}">${m.awayTeam.name}</span>
                        </div>
                    </div>

                    <div style="width: 30px; text-align:right;">
                        <span class="fw-bold small ${resultClass === 'res-win' ? 'text-success' : (resultClass === 'res-loss' ? 'text-danger' : 'text-secondary')}">${resultLabel}</span>
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="text-danger text-center">Erreur chargement historique.</div>';
        }
    }
</script>

<script>
    // Récupérer l'ID du match depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('id');

    document.getElementById('btnRecalculate').addEventListener('click', async function() {
        const btn = this;
        const originalContent = btn.innerHTML;

        // Feedback visuel (Loading)
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calcul...';

        try {
            const res = await fetch(`/api/v1/analyses/${matchId}/recalculate`, {
                method: 'POST'
            });

            if (res.ok) {
                // Recharger la page pour voir les nouvelles probabilités et les logs IA
                window.location.reload();
            } else {
                alert("Erreur lors du recalcul.");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        } catch (e) {
            console.error(e);
            alert("Erreur de connexion au serveur.");
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    });
</script>

</body>
</html>
