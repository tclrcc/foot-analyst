<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Détaillée - Foot Analyst V16</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
        .header-gradient { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 2rem 0; }

        .card { border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border-radius: 12px; transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        .weather-widget { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .score-badge { font-size: 2rem; font-weight: 800; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; backdrop-filter: blur(5px); }

        .prob-bar-container { height: 35px; border-radius: 8px; overflow: hidden; background-color: #e2e8f0; display: flex; font-weight: bold; font-size: 0.9rem; }
        .prob-segment { display: flex; align-items: center; justify-content: center; transition: width 1s ease-in-out; }

        .stat-row { border-bottom: 1px solid #f1f5f9; padding: 12px 0; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 0.9rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .stat-val { font-weight: 700; font-size: 1.1rem; }

        .value-bet { border: 2px solid #fbbf24; background-color: #fffbeb; color: #b45309; }
        .market-group-title { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; margin-bottom: 1rem; }
    </style>
</head>
<body>

<div class="header-gradient mb-4">
    <div class="container">
        <a href="/" class="btn btn-outline-light btn-sm mb-3 rounded-pill px-3"><i class="bi bi-arrow-left me-2"></i>Retour Dashboard</a>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start">
            <div class="mb-3 mb-md-0">
                <span class="badge bg-white text-dark text-uppercase fw-bold mb-2 px-3 py-2" id="leagueName">Championnat</span>
                <h1 class="display-5 fw-bold mb-0">
                    <span class="text-info" id="homeName">Domicile</span>
                    <span class="text-secondary mx-2 fs-4">vs</span>
                    <span class="text-danger" id="awayName">Extérieur</span>
                </h1>
                <small class="text-white-50"><i class="bi bi-calendar-event me-2"></i><span id="matchDate">--/--/----</span></small>
            </div>

            <div class="card weather-widget border-0" style="min-width: 250px;">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fs-6 opacity-75 text-uppercase fw-bold mb-1"><i class="bi bi-geo-alt-fill"></i> Météo Stade</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cloud-sun-fill fs-2 me-3"></i>
                            <div>
                                <h4 class="mb-0 fw-bold">14°C</h4>
                                <small class="opacity-75">Vent: 25 km/h</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5" id="mainContent" style="display:none;">

    <div id="valueBetAlert" class="alert value-bet shadow-sm d-flex align-items-center mb-4" style="display:none;">
        <i class="bi bi-stars fs-3 me-3"></i>
        <div>
            <h5 class="alert-heading fw-bold mb-0">Opportunité Value Bet Détectée !</h5>
            <span id="valueBetDesc">Misez sur ...</span>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-7">

            <div class="card mb-4">
                <div class="card-body p-4">
                    <h6 class="market-group-title"><i class="bi bi-trophy-fill me-2"></i>Résultat du Match (1N2)</h6>

                    <div class="prob-bar-container mb-2">
                        <div id="pb1" class="prob-segment bg-primary text-white" style="width: 33%">1</div>
                        <div id="pbN" class="prob-segment bg-secondary text-white-50" style="width: 34%">N</div>
                        <div id="pb2" class="prob-segment bg-danger text-white" style="width: 33%">2</div>
                    </div>

                    <div class="row text-center mt-3">
                        <div class="col-4 border-end">
                            <div class="text-primary fw-bold display-6" id="prob1">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Victoire Dom.</small>
                            <div id="kel1" class="mt-1"></div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="text-secondary fw-bold display-6" id="probN">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Match Nul</small>
                            <div id="kelN" class="mt-1"></div>
                        </div>
                        <div class="col-4">
                            <div class="text-danger fw-bold display-6" id="prob2">0%</div>
                            <small class="text-muted text-uppercase fw-bold">Victoire Ext.</small>
                            <div id="kel2" class="mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <h6 class="market-group-title"><i class="bi bi-bullseye me-2"></i>Score le plus probable</h6>
                            <div class="score-badge text-dark bg-light d-inline-block mb-2 mt-2" id="exactScore">0-0</div>
                            <div class="text-muted fw-bold">Probabilité: <span id="exactScoreProb" class="text-dark">0%</span></div>
                            <hr class="my-3">
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Espérance Buts Dom: <strong class="text-dark" id="expHome">0.0</strong></span>
                                <span>Espérance Buts Ext: <strong class="text-dark" id="expAway">0.0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <h6 class="market-group-title"><i class="bi bi-shield-shaded me-2"></i>Double Chance</h6>
                            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
                                <span class="fw-bold text-muted">1N (Dom ou Nul)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dc1N">--%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
                                <span class="fw-bold text-muted">12 (Pas de nul)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dc12">--%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center stat-row">
                                <span class="fw-bold text-muted">N2 (Nul ou Ext)</span>
                                <span class="badge bg-light text-dark fs-6 border" id="dcN2">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-5">

            <div class="card mb-4">
                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                    <h6 class="market-group-title mb-0"><i class="bi bi-hash me-2"></i>Total Buts (Under / Over)</h6>
                </div>
                <div class="card-body pt-2">

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 1.5</div>
                            <div class="stat-val text-success" id="u15">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU15" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO15" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 1.5</div>
                            <div class="stat-val text-primary" id="o15">--%</div>
                            <small id="valO15"></small>
                        </div>
                    </div>

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 2.5</div>
                            <div class="stat-val text-success" id="u25">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU25" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO25" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 2.5</div>
                            <div class="stat-val text-primary" id="o25">--%</div>
                            <small id="valO25"></small>
                        </div>
                    </div>

                    <div class="stat-row d-flex justify-content-between align-items-center">
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">UNDER 3.5</div>
                            <div class="stat-val text-success" id="u35">--%</div>
                        </div>
                        <div class="w-50 px-2">
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" id="barU35" style="width: 50%"></div>
                                <div class="progress-bar bg-primary" id="barO35" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="text-center w-25">
                            <div class="small text-muted fw-bold">OVER 3.5</div>
                            <div class="stat-val text-primary" id="o35">--%</div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="market-group-title"><i class="bi bi-arrow-left-right me-2"></i>Les deux équipes marquent (BTTS)</h6>
                    <div class="d-flex justify-content-around align-items-center py-2">
                        <div class="text-center">
                            <h3 class="text-success mb-0 fw-bold" id="bttsYes">--%</h3>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-3">OUI</span>
                            <div id="valBTTS" class="mt-1"></div>
                        </div>
                        <div class="vr" style="height: 50px;"></div>
                        <div class="text-center">
                            <h3 class="text-danger mb-0 fw-bold" id="bttsNo">--%</h3>
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3">NON</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="market-group-title">Power Score (Forces en présence)</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span class="text-primary" id="homePowerName">DOM</span>
                            <span id="homePowerVal">0</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" id="barPowerHome" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span class="text-danger" id="awayPowerName">EXT</span>
                            <span id="awayPowerVal">0</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" id="barPowerAway" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="loader" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 text-muted">Chargement de l'analyse et des données météo...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- UTILS ---
    const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
    const setWidth = (id, val) => { const el = document.getElementById(id); if(el) el.style.width = val + '%'; };

    async function loadAnalysis() {
        // Récup ID depuis l'URL (ex: analysis-details.html?id=12)
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if(!id) {
            alert("Aucun ID d'analyse spécifié.");
            return;
        }

        try {
            // NOTE: Assurez-vous d'ajouter une méthode GET /api/v1/analyses/{id} dans votre Controller Java !
            // Pour l'instant, on suppose que cela fonctionne ou on adapte le controller.
            const res = await fetch(`/api/v1/analyses/${id}`); // A AJOUTER DANS LE BACKEND SI MANQUANT
            if(!res.ok) throw new Error("Analyse introuvable");

            const match = await res.json(); // Objet MatchAnalysis complet
            const p = match.prediction;

            // 1. HEADER
            setText('leagueName', match.homeTeam.league ? match.homeTeam.league.name : 'Championnat');
            setText('homeName', match.homeTeam.name);
            setText('awayName', match.awayTeam.name);
            setText('matchDate', new Date(match.matchDate).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' }));

            // Power Names
            setText('homePowerName', match.homeTeam.name);
            setText('awayPowerName', match.awayTeam.name);

            // 2. 1N2
            setText('prob1', Math.round(p.homeWinProbability) + '%');
            setText('probN', Math.round(p.drawProbability) + '%');
            setText('prob2', Math.round(p.awayWinProbability) + '%');

            setWidth('pb1', p.homeWinProbability); setText('pb1', Math.round(p.homeWinProbability)+'%');
            setWidth('pbN', p.drawProbability); setText('pbN', Math.round(p.drawProbability)+'%');
            setWidth('pb2', p.awayWinProbability); setText('pb2', Math.round(p.awayWinProbability)+'%');

            // 3. SCORES
            setText('exactScore', p.exactScore || 'N/A');
            setText('exactScoreProb', p.exactScoreProb ? Math.round(p.exactScoreProb) + '%' : '-');
            setText('expHome', p.predictedHomeGoals);
            setText('expAway', p.predictedAwayGoals);

            // 4. DOUBLE CHANCE
            setText('dc1N', p.doubleChance1N + '%');
            setText('dc12', p.doubleChance12 + '%');
            setText('dcN2', p.doubleChanceN2 + '%');

            // 5. GOALS MARKETS (Si backend mis à jour avec les nouveaux champs, sinon calcul frontend approx)

            // Over/Under 1.5 (Si pas dans JSON, on approxime depuis Over2.5 pour l'affichage demo)
            // L'idéal est que le backend renvoie p.over1_5_Prob, p.under1_5_Prob
            const o15 = p.probOver1_5 !== undefined ? p.probOver1_5 : Math.min(99, p.over2_5_Prob + 25);
            const u15 = 100 - o15;
            setText('o15', Math.round(o15) + '%'); setWidth('barO15', o15);
            setText('u15', Math.round(u15) + '%'); setWidth('barU15', u15);

            // Over/Under 2.5
            setText('o25', Math.round(p.over2_5_Prob) + '%'); setWidth('barO25', p.over2_5_Prob);
            setText('u25', Math.round(p.under2_5_Prob) + '%'); setWidth('barU25', p.under2_5_Prob);

            // Over/Under 3.5 (Simulé si absent)
            const o35 = p.probOver3_5 !== undefined ? p.probOver3_5 : Math.max(0, p.over2_5_Prob - 20);
            const u35 = 100 - o35;
            setText('o35', Math.round(o35) + '%'); setWidth('barO35', o35);
            setText('u35', Math.round(u35) + '%'); setWidth('barU35', u35);

            // BTTS
            const bttsY = p.bttsProb;
            const bttsN = p.bttsNoProb !== undefined ? p.bttsNoProb : (100 - bttsY); // Fallback
            setText('bttsYes', Math.round(bttsY) + '%');
            setText('bttsNo', Math.round(bttsN) + '%');

            // 6. POWER SCORE
            setText('homePowerVal', Math.round(p.homePowerScore));
            setWidth('barPowerHome', p.homePowerScore);
            setText('awayPowerVal', Math.round(p.awayPowerScore));
            setWidth('barPowerAway', p.awayPowerScore);

            // 7. VALUE BET DETECTION & BADGES
            const addValueBadge = (elId, kelly) => {
                const el = document.getElementById(elId);
                if(kelly > 0 && el) el.innerHTML = `<span class="badge bg-warning text-dark border border-warning mt-1"><i class="bi bi-star-fill me-1"></i>Value!</span>`;
            };

            // 1N2 Value
            if(p.valueBetDetected) {
                const alertBox = document.getElementById('valueBetAlert');
                alertBox.style.display = 'flex';
                let txt = "";
                if(p.kellyStakeHome > 0) { txt = `Victoire ${match.homeTeam.name} (@${match.odds1})`; addValueBadge('kel1', 1); }
                else if(p.kellyStakeAway > 0) { txt = `Victoire ${match.awayTeam.name} (@${match.odds2})`; addValueBadge('kel2', 1); }
                else if(p.kellyStakeDraw > 0) { txt = `Match Nul (@${match.oddsN})`; addValueBadge('kelN', 1); }
                setText('valueBetDesc', txt);
            }

            // Goals Value
            addValueBadge('valO15', p.kellyOver1_5);
            addValueBadge('valO25', p.kellyOver2_5);
            addValueBadge('valBTTS', p.kellyBTTS);

            // FIN CHARGEMENT
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

        } catch(e) {
            console.error(e);
            document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erreur de chargement: ${e.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', loadAnalysis);
</script>

</body>
</html>
