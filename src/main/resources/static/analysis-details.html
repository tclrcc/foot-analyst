<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse de Match - Pro Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .confidence-meter { height: 10px; border-radius: 5px; background: #e9ecef; overflow: hidden; }
        .confidence-fill { height: 100%; transition: width 1s ease-in-out; }
        .bg-value-bet { background-color: #d63384; color: white; } /* Rose flashy pour les Value Bets */
        .log-box { background: #f8f9fa; border-left: 4px solid #0d6efd; padding: 15px; font-family: 'Segoe UI', sans-serif; }
        .log-box ul { padding-left: 20px; margin-bottom: 0; }
        .prompt-box { background: #212529; color: #00ff41; font-family: monospace; border-radius: 5px; padding: 15px; font-size: 0.85rem; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <a href="/" class="btn btn-outline-secondary mb-3"><i class="bi bi-arrow-left"></i> Retour</a>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-center py-4">
            <h5 class="text-muted text-uppercase small fw-bold mb-3" id="matchLeague">...</h5>
            <div class="d-flex justify-content-center align-items-center gap-4">
                <div class="text-end">
                    <h2 class="fw-bold mb-0" id="homeTeamName">...</h2>
                    <span class="badge bg-primary rounded-pill" id="homeFormBadge">Forme: --</span>
                </div>
                <div class="display-6 fw-bold text-muted">vs</div>
                <div class="text-start">
                    <h2 class="fw-bold mb-0" id="awayTeamName">...</h2>
                    <span class="badge bg-danger rounded-pill" id="awayFormBadge">Forme: --</span>
                </div>
            </div>
            <div class="mt-3 text-muted small"><i class="bi bi-calendar-event me-1"></i> <span id="matchDate">--</span></div>

            <button id="btnRecalculate" class="btn btn-sm btn-outline-warning mt-3">
                <i class="bi bi-arrow-clockwise me-1"></i> Actualiser l'analyse
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white fw-bold border-bottom pb-3 pt-3 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bar-chart-line-fill text-primary me-2"></i>Face-√†-Face (Moyennes de la Saison)</span>
        </div>
        <div class="card-body">

            <div class="d-flex justify-content-between mb-4 border-bottom pb-3">
                <div class="text-center w-25">
                    <span class="d-block small text-muted text-uppercase fw-bold">Rang</span>
                    <span class="fs-4 fw-bold text-primary" id="uiHomeRank">#--</span>
                </div>
                <div class="text-center align-self-center w-50">
                    <span class="badge bg-dark text-white border px-3 py-2">Ligue</span>
                </div>
                <div class="text-center w-25">
                    <span class="d-block small text-muted text-uppercase fw-bold">Rang</span>
                    <span class="fs-4 fw-bold text-danger" id="uiAwayRank">#--</span>
                </div>
            </div>

            <h6 class="text-muted text-uppercase small fw-bold mb-3 mt-2">üìä Volume de jeu</h6>
            <div id="comp-possession"></div>
            <div id="comp-shots"></div>
            <div id="comp-sot"></div>
            <div id="comp-corners"></div>

            <h6 class="text-muted text-uppercase small fw-bold mb-3 mt-4">üß† Analyse Tactique Avanc√©e</h6>

            <div class="row text-center mb-3">
                <div class="col-6 border-end">
                    <div class="small text-muted mb-1">xG Moyen (Cr√©ation)</div>
                    <div class="fs-5 fw-bold text-success" id="uiHomeXg">--</div>
                    <div class="fs-5 fw-bold text-danger" id="uiAwayXg">--</div>
                </div>
                <div class="col-6">
                    <div class="small text-muted mb-1">xGA (Solidit√© D√©fensive)</div>
                    <div class="fs-5 fw-bold text-success" id="uiHomeXga">--</div>
                    <div class="fs-5 fw-bold text-danger" id="uiAwayXga">--</div>
                </div>
            </div>

            <div id="comp-ppda" class="mt-2" title="Passes Allowed Per Defensive Action : Plus c'est bas, plus l'√©quipe presse haut et agressivement"></div>
            <div class="text-center small text-muted fst-italic mb-3" style="font-size: 0.7rem;">PPDA : Un score bas indique un pressing agressif (ex: Liverpool = ~9.0)</div>

        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="fw-bold"><i class="bi bi-pie-chart-fill text-primary me-2"></i>Verdict de l'Algorithme</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1 fw-bold">
                            <span class="text-primary">1 - Domicile (<span id="prob1">--</span>%)</span>
                            <span class="text-muted">N - Nul (<span id="probN">--</span>%)</span>
                            <span class="text-danger">2 - Ext√©rieur (<span id="prob2">--</span>%)</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="bar1" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                            <div id="barN" class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            <div id="bar2" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="row text-center g-3 mb-4">
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block text-uppercase fw-bold">Score le + probable</small>
                                <span class="h3 fw-bold text-dark" id="exactScore">--</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block text-uppercase fw-bold">Expected Goals (xG)</small>
                                <span class="h3 fw-bold text-info" id="xgProjected">-- - --</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block text-uppercase fw-bold">Indice Confiance</small>
                                <span class="h3 fw-bold text-success" id="confidenceScore">--%</span>
                                <div class="confidence-meter mt-2"><div id="confidenceBar" class="confidence-fill bg-success" style="width: 0%"></div></div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold text-muted text-uppercase mb-3"><i class="bi bi-lightbulb-fill text-warning me-2"></i>Faits Marquants (S√©ries en cours)</h6>
                    <div class="row g-2" id="insightsContainer">
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 bg-dark text-white">
                <div class="card-header border-secondary bg-transparent pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-robot me-2"></i>Demander un 2√®me avis (ChatGPT / Gemini)</h6>
                        <button class="btn btn-sm btn-light fw-bold" onclick="copyPrompt()">
                            <i class="bi bi-clipboard me-1"></i> Copier
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">Copiez ce prompt optimis√© et collez-le dans votre IA pr√©f√©r√©e pour obtenir une contre-expertise instantan√©e.</p>
                    <textarea id="aiPromptText" class="form-control bg-black text-success border-secondary font-monospace" rows="6" readonly></textarea>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white fw-bold border-bottom pb-3 pt-3">
                    <i class="bi bi-graph-up-arrow text-primary me-2"></i>March√©s des Buts
                </div>
                <div class="card-body">

                    <div class="mb-4">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span>Les 2 √©quipes marquent (BTTS)</span>
                            <span id="uiBtts" class="text-primary">--%</span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 5px;">
                            <div id="barBtts" class="progress-bar bg-primary" style="width: 0%"></div>
                        </div>
                        <div class="small text-muted mt-1 text-end">Non: <span id="uiBttsNo">--</span>%</div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span>Plus de 1.5 Buts (+1.5)</span>
                            <span id="uiOver15" class="text-success">--%</span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 5px;">
                            <div id="barOver15" class="progress-bar bg-success" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span>Plus de 2.5 Buts (+2.5)</span>
                            <span id="uiOver25" class="text-warning">--%</span>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 5px;">
                            <div id="barOver25" class="progress-bar bg-warning" style="width: 0%"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // R√©cup√©ration ID
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('id');

    async function loadAnalysis() {
        try {
            const res = await fetch(`/api/v1/analyses/${matchId}`);
            if (!res.ok) throw new Error("Erreur chargement");
            const match = await res.json();
            const pred = match.prediction;

            // Mapping des classements
            document.getElementById('uiHomeRank').innerText = match.homeStats?.rank ? '#' + match.homeStats.rank : 'N/A';
            document.getElementById('uiAwayRank').innerText = match.awayStats?.rank ? '#' + match.awayStats.rank : 'N/A';

            // 2. G√©n√©ration des barres de comparaison
            renderComparisonBar('comp-possession', 'Possession', match.homeStats?.avgPossession, match.awayStats?.avgPossession, true);
            renderComparisonBar('comp-shots', 'Tirs / match', match.homeStats?.avgShots, match.awayStats?.avgShots);
            renderComparisonBar('comp-sot', 'Tirs Cadr√©s / match', match.homeStats?.avgShotsOnTarget, match.awayStats?.avgShotsOnTarget);
            renderComparisonBar('comp-corners', 'Corners / match', match.homeStats?.avgCorners, match.awayStats?.avgCorners);

// 3. Stats Avanc√©es
            document.getElementById('uiHomeXg').innerText = match.homeStats?.xG || '--';
            document.getElementById('uiAwayXg').innerText = match.awayStats?.xG || '--';
            document.getElementById('uiHomeXga').innerText = match.homeStats?.xGA || '--';
            document.getElementById('uiAwayXga').innerText = match.awayStats?.xGA || '--';

// PPDA : Inverse logic = true, car un petit PPDA = meilleur pressing
            renderComparisonBar('comp-ppda', 'Intensit√© Pressing (PPDA)', match.homeStats?.ppda, match.awayStats?.ppda, false, true);

            // Header info
            document.getElementById('matchLeague').innerText = match.homeTeam.league?.name || "Championnat inconnu";
            document.getElementById('homeTeamName').innerText = match.homeTeam.name;
            document.getElementById('awayTeamName').innerText = match.awayTeam.name;
            document.getElementById('matchDate').innerText = new Date(match.matchDate).toLocaleString();

            // Badges Forme (Utilise Power Score si dispo)
            if(pred) {
                document.getElementById('homeFormBadge').innerText = `Puissance: ${pred.homePowerScore}`;
                document.getElementById('awayFormBadge').innerText = `Puissance: ${pred.awayPowerScore}`;
            }

            if (pred) {
                // Probabilit√©s Bars
                const p1 = pred.homeWinProbability;
                const pN = pred.drawProbability;
                const p2 = pred.awayWinProbability;

                document.getElementById('prob1').innerText = p1;
                document.getElementById('probN').innerText = pN;
                document.getElementById('prob2').innerText = p2;

                document.getElementById('bar1').style.width = `${p1}%`;
                document.getElementById('barN').style.width = `${pN}%`;
                document.getElementById('bar2').style.width = `${p2}%`;

                // Stats Principales
                document.getElementById('exactScore').innerText = pred.exactScore;
                document.getElementById('xgProjected').innerText = `${pred.predictedHomeGoals} - ${pred.predictedAwayGoals}`;

                // Confiance & Volatilit√©
                const conf = pred.confidenceScore || 70; // Valeur par d√©faut si ancien calcul
                document.getElementById('confidenceScore').innerText = conf + '%';
                document.getElementById('confidenceBar').style.width = conf + '%';

                // Couleur dynamique barre confiance
                const confBar = document.getElementById('confidenceBar');
                if(conf < 50) confBar.className = 'confidence-fill bg-danger';
                else if(conf < 75) confBar.className = 'confidence-fill bg-warning';
                else confBar.className = 'confidence-fill bg-success';

                if (pred.keyFacts && pred.keyFacts.length > 0) {
                    const container = document.getElementById('insightsContainer');
                    container.innerHTML = pred.keyFacts.map(fact => {
                        // Applique un style diff√©rent en fonction de l'emoji g√©n√©r√© par le backend
                        let bgClass = "bg-primary bg-opacity-10 text-primary";
                        if(fact.includes("üî•")) bgClass = "bg-danger bg-opacity-10 text-danger";
                        if(fact.includes("‚ö†Ô∏è")) bgClass = "bg-warning bg-opacity-10 text-dark";
                        if(fact.includes("üõ°Ô∏è") || fact.includes("üéØ")) bgClass = "bg-success bg-opacity-10 text-success";

                        return `<div class="col-12">
                   <div class="p-3 rounded border border-light shadow-sm ${bgClass} fw-bold" style="font-size:0.9rem;">
                       ${fact}
                   </div>
                </div>`;
                    }).join('');
                } else {
                    document.getElementById('insightsContainer').innerHTML =
                        `<div class="col-12 text-muted fst-italic">Aucune tendance majeure d√©tect√©e par l'algorithme.</div>`;
                }

                // AI Prompt
                if (pred.aiAnalysisPrompt) {
                    document.getElementById('aiPromptText').value = pred.aiAnalysisPrompt;
                }

                // March√©s Alternatifs UI
                document.getElementById('uiBtts').innerText = pred.bttsProb + '%';
                document.getElementById('barBtts').style.width = pred.bttsProb + '%';
                document.getElementById('uiBttsNo').innerText = pred.probBTTS_No;

                document.getElementById('uiOver15').innerText = pred.probOver1_5 + '%';
                document.getElementById('barOver15').style.width = pred.probOver1_5 + '%';

                document.getElementById('uiOver25').innerText = pred.over2_5_Prob + '%';
                document.getElementById('barOver25').style.width = pred.over2_5_Prob + '%';

                // Value Bet Display
                if (pred.valueBetDetected) {
                    document.getElementById('valueBetCard').style.display = 'block';
                    let teamName = "";
                    if (pred.valueBetDetected === "HOME") teamName = match.homeTeam.name;
                    else if (pred.valueBetDetected === "AWAY") teamName = match.awayTeam.name;
                    else teamName = "Match Nul";
                    document.getElementById('valueBetTeam').innerText = teamName;
                }
            }

        } catch (e) {
            console.error(e);
            alert("Impossible de charger l'analyse.");
        }
    }

    function renderComparisonBar(elementId, label, homeVal, awayVal, isPercentage = false, inverseLogic = false) {
        const hVal = parseFloat(homeVal) || 0;
        const aVal = parseFloat(awayVal) || 0;
        const total = hVal + aVal;

        let hPct = 50, aPct = 50;
        if(total > 0) {
            hPct = (hVal / total) * 100;
            aPct = (aVal / total) * 100;
        }

        // Gestion de l'affichage (avec ou sans %)
        let hDisplay = isPercentage ? hVal + '%' : hVal;
        let aDisplay = isPercentage ? aVal + '%' : aVal;

        // Pour certaines stats (comme le PPDA, un score FAIBLE est meilleur), on peut inverser les couleurs (Optionnel)
        let homeColor = inverseLogic && hVal > aVal ? "bg-secondary" : "bg-primary";
        let awayColor = inverseLogic && aVal > hVal ? "bg-secondary" : "bg-danger";

        document.getElementById(elementId).innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between small fw-bold mb-1">
                <span class="text-primary">${hDisplay}</span>
                <span class="text-muted text-uppercase" style="font-size:0.75rem;">${label}</span>
                <span class="text-danger">${aDisplay}</span>
            </div>
            <div class="progress shadow-sm" style="height: 10px; border-radius: 5px; background-color:#e9ecef;">
                <div class="progress-bar ${homeColor}" style="width: ${hPct}%"></div>
                <div class="progress-bar ${awayColor}" style="width: ${aPct}%"></div>
            </div>
        </div>
    `;
    }

    // Gestion du Recalcul
    document.getElementById('btnRecalculate').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calcul...';

        try {
            const res = await fetch(`/api/v1/analyses/${matchId}/recalculate`, { method: 'POST' });
            if (res.ok) {
                window.location.reload();
            } else {
                alert("Erreur lors du recalcul.");
            }
        } catch(e) { console.error(e); }
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Actualiser l\'analyse';
    });

    function copyPrompt() {
        const copyText = document.getElementById("aiPromptText");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        alert("Prompt copi√© ! Colle-le dans ChatGPT/Gemini.");
    }

    loadAnalysis();
</script>

</body>
</html>
