<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foot Analyst AI - Pro Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --success: #10b981;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
    }

    /* Navbar */
    .navbar {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    /* Hero Section */
    .hero-stat {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 1.5rem;
      transition: transform 0.3s ease;
    }
    .hero-stat:hover { transform: translateY(-5px); border-color: var(--accent); }

    /* Match Card Design */
    .match-card {
      background-color: var(--bg-card);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }

    .match-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
      border-color: rgba(255,255,255,0.1);
    }

    .league-badge {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .team-name { font-weight: 700; font-size: 1.1rem; margin-top: 0.5rem; }
    .vs-badge { font-size: 0.8rem; font-weight: 800; color: var(--text-muted); opacity: 0.5; }

    /* AI Probability Badge */
    .ai-badge {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .ai-badge.high-conf {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border-color: var(--success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
    }

    .btn-analyze {
      background: var(--accent);
      border: none;
      font-weight: 600;
      width: 100%;
      padding: 0.8rem;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .btn-analyze:hover { background: #2563eb; box-shadow: 0 0 15px var(--accent-glow); color: white;}

    /* Loader */
    .loader-container { min-height: 300px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand text-white fw-bold" href="#">
      <i class="bi bi-cpu-fill text-primary me-2"></i>Foot Analyst <span class="badge bg-primary ms-1" style="font-size: 0.6em;">PRO</span>
    </a>
    <div class="d-flex">
      <a href="/admin.html" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
        <i class="bi bi-gear-fill me-2"></i>Admin
      </a>
    </div>
  </div>
</nav>

<div class="container" style="margin-top: 100px;">

  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="hero-stat">
        <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.8rem;">Matchs à Venir</h6>
        <h2 class="fw-bold mb-0 text-white" id="countUpcoming">--</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="hero-stat">
        <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.8rem;">Confiance IA Moyenne</h6>
        <h2 class="fw-bold mb-0 text-info" id="avgConfidence">--%</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="hero-stat">
        <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.8rem;">Value Bets Détectés</h6>
        <h2 class="fw-bold mb-0 text-success" id="countValueBets">--</h2>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-end mb-4 border-bottom border-secondary pb-3">
    <div>
      <h3 class="fw-bold mb-1">Prochaines Affiches</h3>
      <p class="text-muted small mb-0">Analyse IA en temps réel des matchs importés.</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary active">Tous</button>
      <button class="btn btn-sm btn-outline-secondary">Premier League</button>
      <button class="btn btn-sm btn-outline-secondary">Ligue 1</button>
    </div>
  </div>

  <div id="matchesGrid" class="row g-4">
    <div class="col-12 loader-container">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- UTILS ---
  const formatDate = (iso) => {
    const d = new Date(iso);
    const today = new Date();
    const isToday = d.getDate() === today.getDate() && d.getMonth() === today.getMonth();

    if(isToday) return `Aujourd'hui à ${d.getHours()}h${d.getMinutes().toString().padStart(2, '0')}`;
    return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
  };

  // --- LOGIC ---
  async function loadUpcomingMatches() {
    const grid = document.getElementById('matchesGrid');

    try {
      const res = await fetch('/api/v1/analyses/upcoming');
      if (!res.ok) throw new Error("Erreur API");

      const matches = await res.json();

      // Update KPI
      document.getElementById('countUpcoming').innerText = matches.length;
      const values = matches.filter(m => m.prediction && m.prediction.valueBetDetected).length;
      document.getElementById('countValueBets').innerText = values;

      // Calcul confiance moyenne
      let totalConf = 0;
      let countConf = 0;
      matches.forEach(m => {
        if(m.prediction) {
          const maxP = Math.max(m.prediction.homeWinProbability, m.prediction.drawProbability, m.prediction.awayWinProbability);
          totalConf += maxP;
          countConf++;
        }
      });
      document.getElementById('avgConfidence').innerText = countConf > 0 ? Math.round(totalConf/countConf) + '%' : '--';

      // Render Cards
      if (matches.length === 0) {
        grid.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
            <p class="mt-3 text-muted">Aucun match à venir détecté.<br>Allez dans l'Admin pour importer les dernières données.</p>
            <a href="/admin.html" class="btn btn-primary mt-2">Aller à l'import</a>
          </div>`;
        return;
      }

      grid.innerHTML = matches.map(m => createMatchCard(m)).join('');

    } catch (e) {
      console.error(e);
      grid.innerHTML = `<div class="col-12 text-center text-danger">Impossible de charger les matchs. Vérifiez le serveur.</div>`;
    }
  }

  function createMatchCard(m) {
    const p = m.prediction;

    // Déterminer la prédiction principale
    let predBadge = '<span class="badge bg-secondary">En attente</span>';
    let highlightClass = '';

    if (p) {
      const probs = [
        { label: '1', val: p.homeWinProbability },
        { label: 'N', val: p.drawProbability },
        { label: '2', val: p.awayWinProbability }
      ];
      // Trouver la plus haute proba
      const best = probs.reduce((prev, current) => (prev.val > current.val) ? prev : current);

      const isHighConf = best.val > 60;
      const colorClass = isHighConf ? 'high-conf' : '';
      const icon = isHighConf ? '<i class="bi bi-lightning-charge-fill"></i>' : '<i class="bi bi-bar-chart-fill"></i>';

      predBadge = `
          <div class="ai-badge ${colorClass}">
            ${icon} ${m.homeTeam.name} (${Math.round(best.val)}%)
          </div>
        `;

      if (best.label === '2') {
        predBadge = `<div class="ai-badge ${colorClass}">${icon} ${m.awayTeam.name} (${Math.round(best.val)}%)</div>`;
      } else if (best.label === 'N') {
        predBadge = `<div class="ai-badge ${colorClass}">${icon} Nul (${Math.round(best.val)}%)</div>`;
      }

      let extraBadges = '';

      // Value Bet ?
      if (p.valueBetDetected) {
        highlightClass = 'border-warning';
        extraBadges += `<span class="badge bg-warning text-dark ms-2 mb-1 shadow-sm"><i class="bi bi-star-fill"></i> Value</span>`;
      }

      // NOUVEAU : Détection automatique des matchs à fort potentiel offensif (Facteur de Chaos)
      if (p.bttsProb > 65) {
        extraBadges += `<span class="badge bg-danger text-white ms-1 mb-1 shadow-sm"><i class="bi bi-fire"></i> BTTS (Oui)</span>`;
      }
      if (p.over2_5_Prob > 60) {
        extraBadges += `<span class="badge bg-success text-white ms-1 mb-1 shadow-sm"><i class="bi bi-futbol"></i> +2.5 Buts</span>`;
      }

      predBadge += `<div class="mt-2 flex-wrap d-flex justify-content-center">${extraBadges}</div>`;
    }

    return `
      <div class="col-lg-4 col-md-6">
        <div class="match-card p-4 ${highlightClass} h-100 d-flex flex-column">

          <div class="d-flex justify-content-between align-items-start mb-3">
            <span class="league-badge"><i class="bi bi-flag-fill me-1"></i>${m.homeTeam.league ? m.homeTeam.league.name : 'Ligue'}</span>
            <small class="text-muted" style="font-size: 0.75rem;">${formatDate(m.matchDate)}</small>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-4 flex-grow-1">
            <div class="text-center w-40">
              <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center mx-auto mb-2 border border-secondary" style="width:50px; height:50px;">
                <span class="fw-bold fs-5">${m.homeTeam.name.charAt(0)}</span>
              </div>
              <div class="team-name text-truncate" style="max-width: 120px;" title="${m.homeTeam.name}">${m.homeTeam.name}</div>
            </div>

            <div class="text-center w-20">
              <span class="vs-badge">VS</span>
            </div>

            <div class="text-center w-40">
              <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center mx-auto mb-2 border border-secondary" style="width:50px; height:50px;">
                <span class="fw-bold fs-5">${m.awayTeam.name.charAt(0)}</span>
              </div>
              <div class="team-name text-truncate" style="max-width: 120px;" title="${m.awayTeam.name}">${m.awayTeam.name}</div>
            </div>
          </div>

          <div class="text-center mb-3">
            ${predBadge}
          </div>

          <a href="/analysis-details.html?id=${m.id}" class="btn btn-analyze text-white text-decoration-none text-center">
            <i class="bi bi-eye-fill me-2"></i>Voir l'analyse
          </a>
        </div>
      </div>
    `;
  }

  document.addEventListener('DOMContentLoaded', loadUpcomingMatches);
</script>

</body>
</html>
