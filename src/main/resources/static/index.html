<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foot Analyst AI - V3</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .stats-input { font-size: 0.9rem; }
    .prediction-card { display: none; transition: all 0.3s ease; }
    .score-box { font-size: 2rem; font-weight: bold; }
    .win-prob { height: 25px; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-4 shadow-sm">
  <div class="container d-flex justify-content-between">
    <span class="navbar-brand mb-0 h1">‚öΩ Foot Analyst Architect <span class="badge bg-white text-primary fs-6">V3</span></span>
    <a href="/admin.html" class="btn btn-outline-light btn-sm">‚öôÔ∏è Admin</a>
  </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col-lg-7">
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 text-primary">üìù Nouvelle Analyse</h5>
        </div>
        <div class="card-body p-4">
          <form id="analysisForm">

            <div class="mb-4">
              <label class="form-label fw-bold">Championnat</label>
              <select class="form-select" id="leagueSelect" required>
                <option value="" selected disabled>Chargement des ligues...</option>
              </select>
              <input type="hidden" id="leagueName">
            </div>

            <div class="row mb-4">
              <div class="col">
                <label class="form-label fw-bold">Domicile</label>
                <select class="form-select" id="homeTeamSelect" disabled required>
                  <option value="" selected disabled>Choisir ligue d'abord</option>
                </select>
              </div>
              <div class="col">
                <label class="form-label fw-bold">Ext√©rieur</label>
                <select class="form-select" id="awayTeamSelect" disabled required>
                  <option value="" selected disabled>Choisir ligue d'abord</option>
                </select>
              </div>
            </div>

            <hr class="my-4">

            <div class="row g-2 align-items-center mb-3">
              <div class="col-2 text-center small text-muted text-uppercase">Statistique</div>
              <div class="col-5 text-center text-primary fw-bold">Domicile</div>
              <div class="col-5 text-center text-danger fw-bold">Ext√©rieur</div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-2 text-end align-self-center"><small>Classement</small></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="homeRank" required min="1" max="50"></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="awayRank" required min="1" max="50"></div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-2 text-end align-self-center"><small>Points</small></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="homePoints" required min="0"></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="awayPoints" required min="0"></div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-2 text-end align-self-center"><small>Forme (5m)</small></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="homeForm" placeholder="Pts (0-15)"></div>
              <div class="col-5"><input type="number" class="form-control stats-input" id="awayForm" placeholder="Pts (0-15)"></div>
            </div>

            <div class="row g-2 mb-4">
              <div class="col-2 text-end align-self-center"><small>xG Moyen</small></div>
              <div class="col-5"><input type="number" step="0.01" class="form-control stats-input" id="homeXg" placeholder="Ex: 1.85"></div>
              <div class="col-5"><input type="number" step="0.01" class="form-control stats-input" id="awayXg" placeholder="Ex: 0.90"></div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-sm">
              Lancer l'Algorithme üöÄ
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div id="resultCard" class="card shadow prediction-card border-0">
        <div class="card-header bg-success text-white text-center py-3">
          <h4 class="mb-0">üîÆ Pr√©diction G√©n√©r√©e</h4>
        </div>
        <div class="card-body text-center p-4">
          <h5 class="text-muted mb-4" id="matchTitle">...</h5>

          <div class="row mb-4">
            <div class="col">
              <div class="text-primary fw-bold text-uppercase small">Force Domicile</div>
              <div class="score-box text-primary" id="homePowerDisplay">0</div>
            </div>
            <div class="col">
              <div class="text-danger fw-bold text-uppercase small">Force Ext.</div>
              <div class="score-box text-danger" id="awayPowerDisplay">0</div>
            </div>
          </div>

          <label class="form-label text-start w-100 fw-bold mb-2">Probabilit√©s de victoire</label>
          <div class="progress win-prob mb-3 shadow-sm" style="height: 35px;">
            <div id="probBarHome" class="progress-bar bg-primary" role="progressbar" style="width: 0%">0%</div>
            <div id="probBarDraw" class="progress-bar bg-secondary" role="progressbar" style="width: 0%">Nul</div>
            <div id="probBarAway" class="progress-bar bg-danger" role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- 1. CHARGEMENT DES DONN√âES AU D√âMARRAGE ---
  document.addEventListener('DOMContentLoaded', async () => {
    const leagueSelect = document.getElementById('leagueSelect');

    try {
      const response = await fetch('/api/v1/references/leagues');
      const leagues = await response.json();

      leagueSelect.innerHTML = '<option value="" selected disabled>Choisir un championnat</option>';
      leagues.forEach(league => {
        // On stocke l'ID dans value, et le Nom en texte
        const option = document.createElement('option');
        option.value = league.id;
        option.text = league.name;
        leagueSelect.appendChild(option);
      });
    } catch (e) {
      console.error("Erreur chargement ligues", e);
      leagueSelect.innerHTML = '<option disabled>Erreur API</option>';
    }
  });

  // --- 2. LOGIQUE CASCADE (Quand on change de ligue) ---
  document.getElementById('leagueSelect').addEventListener('change', async function() {
    const leagueId = this.value; // C'est l'ID (Long)
    const leagueName = this.options[this.selectedIndex].text; // C'est le nom (String)

    // On met √† jour le champ cach√© pour l'envoi au backend
    document.getElementById('leagueName').value = leagueName;

    const homeSelect = document.getElementById('homeTeamSelect');
    const awaySelect = document.getElementById('awayTeamSelect');

    // Reset des dropdowns
    homeSelect.innerHTML = '<option>Chargement...</option>';
    awaySelect.innerHTML = '<option>Chargement...</option>';
    homeSelect.disabled = true;
    awaySelect.disabled = true;

    try {
      const response = await fetch(`/api/v1/references/leagues/${leagueId}/teams`);
      const teams = await response.json();

      const fillOptions = (select) => {
        select.innerHTML = '<option value="" selected disabled>Choisir √©quipe</option>';
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.name; // On utilise le NOM comme valeur pour le backend existant
          option.text = team.name;
          select.appendChild(option);
        });
        select.disabled = false;
      };

      fillOptions(homeSelect);
      fillOptions(awaySelect);

    } catch (e) {
      console.error("Erreur chargement √©quipes", e);
    }
  });

  // --- 3. SOUMISSION DU FORMULAIRE ---
  document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    const payload = {
      // On r√©cup√®re les valeurs des SELECT (qui sont les Noms des √©quipes)
      leagueNameInput: document.getElementById('leagueName').value,
      homeTeamNameInput: document.getElementById('homeTeamSelect').value,
      awayTeamNameInput: document.getElementById('awayTeamSelect').value,
      matchDate: tomorrow.toISOString(),

      homeStats: {
        rank: document.getElementById('homeRank').value,
        points: document.getElementById('homePoints').value,
        last5MatchesPoints: document.getElementById('homeForm').value || null,
        xG: document.getElementById('homeXg').value || null
      },
      awayStats: {
        rank: document.getElementById('awayRank').value,
        points: document.getElementById('awayPoints').value,
        last5MatchesPoints: document.getElementById('awayForm').value || null,
        xG: document.getElementById('awayXg').value || null
      }
    };

    try {
      const response = await fetch('/api/v1/analyses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorJson = await response.json();
        alert("Erreur de validation !\n" + JSON.stringify(errorJson, null, 2));
        return;
      }

      const data = await response.json();
      displayResult(data);

    } catch (error) {
      console.error('Erreur technique:', error);
      alert("Erreur technique");
    }
  });

  function displayResult(data) {
    const p = data.prediction;
    const homeName = data.homeTeam ? data.homeTeam.name : "Domicile";
    const awayName = data.awayTeam ? data.awayTeam.name : "Ext√©rieur";

    document.getElementById('matchTitle').innerText = `${homeName} vs ${awayName}`;
    document.getElementById('homePowerDisplay').innerText = p.homePowerScore;
    document.getElementById('awayPowerDisplay').innerText = p.awayPowerScore;

    const barHome = document.getElementById('probBarHome');
    const barDraw = document.getElementById('probBarDraw');
    const barAway = document.getElementById('probBarAway');

    barHome.style.width = `${p.homeWinProbability}%`;
    barHome.innerText = `${p.homeWinProbability}%`;
    barDraw.style.width = `${p.drawProbability}%`;
    barDraw.innerText = `Nul ${p.drawProbability}%`;
    barAway.style.width = `${p.awayWinProbability}%`;
    barAway.innerText = `${p.awayWinProbability}%`;

    document.getElementById('resultCard').style.display = 'block';
  }
</script>

</body>
</html>
